{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Geist font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% if title %}{{ title }} | Voxa{% else %}Voxa{% endif %}</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --voxa-bg: #0b0b10;        /* very dark */
      --voxa-surface: #0f1116;   /* card surface */
      --voxa-muted: #9aa3b2;     /* muted text */
      --voxa-accent: #6f49ff;    /* purple */
      --voxa-accent-2:#2bd4d6;   /* teal accent for highlights */
    }
@layer base {
  html {
    font-family: 'Geist', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
  }
}
</style>
</head>
<body class="bg-[color:var(--voxa-bg)] text-gray-100 antialiased">

  <!-- NAVBAR -->
  <nav class="fixed inset-x-0 top-0 z-30 border-b border-gray-800 bg-[rgba(6,7,10,0.6)] backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="{% url 'blog-home' %}" class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-[color:var(--voxa-accent)] to-[color:var(--voxa-accent-2)] flex items-center justify-center">
          <span class="font-bold text-sm">V</span>
        </div>
        <span class="text-lg font-semibold">Voxa</span>
      </a>

      <div class="hidden sm:flex items-center gap-4 text-sm text-[color:var(--voxa-muted)]">
        <a href="{% url 'blog-home' %}" class="hover:text-white transition">Home</a>
        <a href="{% url 'blog-about' %}" class="hover:text-white transition">About</a>

        {% if user.is_authenticated %}
          <a href="{% url 'post-create' %}" class="px-3 py-1 bg-[color:var(--voxa-accent)] text-black rounded-md hover:opacity-95 transition">Create</a>
          <a href="{% url 'profile' %}" class="hover:text-white transition">Profile</a>
          <form action="{% url 'logout' %}" method="post" class="inline">
            {% csrf_token %}
            <button type="submit" class="hover:text-red-400 transition">Logout</button>
          </form>
        {% else %}
          <!-- trigger modal or link -->
          <button id="loginBtn" class="px-3 py-1 border border-gray-700 rounded-md text-[color:var(--voxa-muted)] hover:text-white">Login</button>
          <button id="joinBtn" class="px-3 py-1 bg-[color:var(--voxa-accent)] text-black rounded-md hover:opacity-95 transition">
            Join
          </button>
        {% endif %}
      </div>

      <!-- Mobile menu / quick icons -->
      <div class="sm:hidden text-[color:var(--voxa-muted)]">
        {% if user.is_authenticated %}
          <a href="{% url 'profile' %}" title="Profile" class="inline-block">ðŸ‘¤</a>
        {% else %}
          <button id="loginBtnMobile">Log in</button>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="pt-24">
    <div class="max-w-7xl mx-auto px-6">
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="mt-16 pb-10">
    <div class="max-w-7xl mx-auto px-6 border-t border-gray-800 pt-8 text-[color:var(--voxa-muted)] text-sm">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div>Â© {{ now|date:"Y" }} Voxa. All rights reserved.</div>
        <div class="flex gap-4">
          <a href="#" class="hover:text-white">Terms</a>
          <a href="#" class="hover:text-white">Privacy</a>
          <a href="#" class="hover:text-white">Contact</a>
        </div>
      </div>
    </div>
  </footer>

<!-- âœ… LOGIN MODAL -->
 <div id="loginModal" 
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 hidden z-50 opacity-0 transition-opacity duration-300">
  <div class="bg-white text-gray-900 rounded-2xl shadow-2xl p-8 w-96 relative transform transition-all duration-300 scale-90">

    <button id="closeLoginModal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-semibold text-center mb-6 text-gray-800">Welcome Back</h2>

    <form id="loginForm" method="POST" action="{% url 'ajax_login' %}">
      {% csrf_token %}
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Username</label>
        <input type="text" name="username" class="w-full border border-gray-300 px-4 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Password</label>
        <input type="password" name="password" class="w-full border border-gray-300 px-4 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="flex items-center justify-between mb-4 text-sm">
        <label class="flex items-center space-x-2">
          <input type="checkbox" class="form-checkbox border-gray-300">
          <span>Remember me</span>
        </label>
        <a href="{% url 'password_reset' %}" class="text-blue-500 hover:underline">Forgot password?</a>
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-md font-medium">Login</button>
    </form>

    <p class="text-center text-sm text-gray-500 mt-4">
      Donâ€™t have an account?
      <button id="openJoinModalFromLogin" class="text-blue-500 hover:underline">Join now</button>
    </p>
  </div>
</div>


<!-- âœ… JOIN (REGISTER) MODAL -->
 <div id="joinModal" 
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 hidden z-50 opacity-0 transition-opacity duration-300">
  <div class="bg-white text-gray-900 rounded-2xl shadow-2xl p-8 w-96 relative transform transition-all duration-300 scale-90">

    <button id="closeJoinModal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-semibold text-center mb-6 text-gray-800">Create an Account</h2>

    <form method="POST" action="{% url 'register' %}">
      {% csrf_token %}
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Username</label>
        <input type="text" name="username" class="w-full border border-gray-300 px-4 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Email</label>
        <input type="email" name="email" class="w-full border border-gray-300 px-4 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Password</label>
        <input type="password" name="password1" class="w-full border border-gray-300 px-4 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm text-gray-600 mb-1">Confirm Password</label>
        <input type="password" name="password2" class="w-full border border-gray-300 px-4 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-md font-medium">Join</button>
    </form>

    <p class="text-center text-sm text-gray-500 mt-4">
      Already have an account?
      <button id="openLoginModalFromJoin" class="text-blue-500 hover:underline">Login</button>
    </p>
  </div>
</div>


<script>
  const loginBtn = document.getElementById('loginBtn');
  const joinBtn = document.getElementById('joinBtn');
  const loginModal = document.getElementById('loginModal');
  const joinModal = document.getElementById('joinModal');
  const closeLoginModal = document.getElementById('closeLoginModal');
  const closeJoinModal = document.getElementById('closeJoinModal');
  const openJoinModalFromLogin = document.getElementById('openJoinModalFromLogin');
  const openLoginModalFromJoin = document.getElementById('openLoginModalFromJoin');

  // Utility functions
  function openModal(modal) {
    modal.classList.remove('hidden');
    requestAnimationFrame(() => {
      modal.classList.remove('opacity-0');
      modal.querySelector('div').classList.remove('scale-90');
      modal.querySelector('div').classList.add('scale-100');
    });
  }

  function closeModal(modal) {
    modal.classList.add('opacity-0');
    modal.querySelector('div').classList.remove('scale-100');
    modal.querySelector('div').classList.add('scale-90');
    setTimeout(() => modal.classList.add('hidden'), 300);
  }

  // Open modals
  loginBtn?.addEventListener('click', () => openModal(loginModal));
  joinBtn?.addEventListener('click', () => openModal(joinModal));

  // Close modals
  closeLoginModal?.addEventListener('click', () => closeModal(loginModal));
  closeJoinModal?.addEventListener('click', () => closeModal(joinModal));

  // Switch between modals
  openJoinModalFromLogin?.addEventListener('click', () => {
    closeModal(loginModal);
    setTimeout(() => openModal(joinModal), 300);
  });

  openLoginModalFromJoin?.addEventListener('click', () => {
    closeModal(joinModal);
    setTimeout(() => openModal(loginModal), 300);
  });

  // Click outside to close
  window.addEventListener('click', (e) => {
    if (e.target === loginModal) closeModal(loginModal);
    if (e.target === joinModal) closeModal(joinModal);
  });
</script>

<script>
document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]')?.value;

  const response = await fetch("{% url 'ajax_login' %}", {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'X-CSRFToken': csrfToken,
    },
    body: formData,
  });

  if (response.ok) {
    const result = await response.json().catch(() => ({}));

    if (result.success) {
      document.getElementById('loginModal').classList.add('hidden');
      window.location.reload();
    } else {
      alert(result.error || 'Invalid username or password');
    }
  } else {
    const errorText = await response.text();
    console.error('Server error:', response.status, errorText);
    alert('Login failed. Please try again.');
  }
});

</script>

<script>
function showToast(message, type = "success") {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');

  // Different colors for success or error
  const colors = {
    success: "bg-green-600",
    error: "bg-red-600"
  };

  toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in`;
  toast.innerHTML = `
    <span class="text-white text-sm font-medium">${message}</span>
  `;

  container.appendChild(toast);

  // Animate out after 3 seconds
  setTimeout(() => {
    toast.classList.add('opacity-0', 'translate-x-10');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}
</script>

<script>
document.querySelector('#joinModal form')?.addEventListener('submit', async function (e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);
  const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]')?.value;
  const submitBtn = form.querySelector('button[type="submit"]');

  // âœ… Start loading state
  submitBtn.disabled = true;
  submitBtn.textContent = "Creating...";

  try {
    const response = await fetch("{% url 'register' %}", {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken,
      },
      body: formData,
    });

    if (response.ok) {
      const result = await response.json().catch(() => ({}));

     if (result.success) {
      showToast('Account created successfully! Welcome ðŸ‘‹', 'success');
      closeModal(joinModal);

      // Reload to show the logged-in UI (Profile + Logout)
      setTimeout(() => {
        window.location.href = "/";
      }, 1200);
    }

      else {
        // Show form errors if available
        let errorMessage = 'Registration failed. Please check your details.';
        try {
          const errors = JSON.parse(result.error || '{}');
          const fields = Object.entries(errors)
            .map(([field, messages]) => `${field}: ${messages.map(m => m.message).join(', ')}`)
            .join('\n');
          errorMessage = fields || errorMessage;
        } catch {}
        alert(errorMessage);
      }
    } else {
      console.error('Server error:', response.status);
      showToast(errorMessage, 'error');
    }
  } catch (err) {
    console.error('Error:', err);
    alert('Network error. Please try again.');
  } finally {
    // End loading state
    submitBtn.disabled = false;
    submitBtn.textContent = "Join";
  }
});
</script>

<!-- Toast Notification Container -->
<div id="toastContainer" class="fixed top-6 right-6 z-[9999] space-y-3"></div>

</body>
</html>